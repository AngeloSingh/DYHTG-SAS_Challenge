<!-- Borrowed and modified code from : https://medium.com/@predragdavidovic10/native-dual-range-slider-html-css-javascript-91e778134816  -->
  
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Campus Visualisation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
  </head>

  
<style> 
#map {
    height: 400px; 
    width: 100%;  
   }  
    
.range_container {
  display: flex;
  flex-direction: column;
  width: 70%;
  margin: 2.5% auto;
}

.sliders_control {
  position: relative;
  min-height: 25px;
}

.form_control {
  position: relative;
  display: flex;
  justify-content: space-between;
  font-size: 24px;
  color: #635a5a;
}

input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none;
  pointer-events: all;
  width: 24px;
  height: 24px;
  background-color: #fff;
  border-radius: 50%;
  box-shadow: 0 0 0 1px #C6C6C6;
  cursor: pointer;
}

input[type=range]::-moz-range-thumb {
  -webkit-appearance: none;
  pointer-events: all;
  width: 24px;
  height: 24px;
  background-color: #fff;
  border-radius: 50%;
  box-shadow: 0 0 0 1px #C6C6C6;
  cursor: pointer;  
}

input[type=range]::-webkit-slider-thumb:hover {
  background: #f7f7f7;
}

input[type=range]::-webkit-slider-thumb:active {
  box-shadow: inset 0 0 3px #387bbe, 0 0 9px #387bbe;
  -webkit-box-shadow: inset 0 0 3px #387bbe, 0 0 9px #387bbe;
}

input[type="number"] {
  color: #8a8383;
  width: 50px;
  height: 30px;
  font-size: 20px;
  border: none;
}

input[type=number]::-webkit-inner-spin-button, 
input[type=number]::-webkit-outer-spin-button {  
   opacity: 1;
}

input[type="range"] {
  -webkit-appearance: none; 
  appearance: none;
  height: 2px;
  width: 100%;
  position: absolute;
  background-color: #C6C6C6;
  pointer-events: none;
}

#fromSlider {
  height: 0;
  z-index: 1;
}
</style> 
<h3>Campus Map</h3>  
<button onclick="sendTimes()">Click to Update</button> 
<button id = "toggle-heatmap">Toggle Heatmap</button> 
<input id = "change-radius" type="range" value="20" min="0" max="100" oninput = "changeRadius()"/>
<div class="range_container">
    <div class="sliders_control">
        <input id="fromSlider" type="range" value="0" min="0" step = "15" max="1439"/>
        <input id="toSlider" type="range" value="1439" min="0" step = "15" max="1439"/>
    </div>
    <div class="form_control">
        <div class="form_control_container">
            <div class="form_control_container__time">Min</div>
            <p class="form_control_container__time__input" id="fromInput">00:00</p>
        </div>
        <div class="form_control_container">
            <div class="form_control_container__time">Max</div> 
            <p class="form_control_container__time__input" id="toInput">23:59</p>
        </div>
    </div>
</div> 
<div id="map">  
</div>  
<div class="dropdown">
    <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      Locations
    </button>
    <div id = "locations" class="dropdown-menu" aria-labelledby="dropdownMenuButton">
    </div>
  </div> 

<!-- <div class="container text-center">
    <div id = "row-of-columns" class="row">
      
    </div>
  </div>  -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3" crossorigin="anonymous"></script>
 
<script async
  src="https://maps.googleapis.com/maps/api/js?key=&libraries=visualization&callback=initMap">
</script>



<script>   

  var timeStartG; 
  var timeEndG;  
  var buildings = new Object(); 
  var map; 
  var heatmap; 
  
  document.getElementById("toggle-heatmap").addEventListener("click", toggleHeatmap);  
  document.getElementById("change-radius").addEventListener("click", changeRadius);

    
    function changeRadius() {  
        let value = document.getElementById("change-radius").value; 
        changeRadiusInner(value);
    }
    function changeRadiusInner(value) {  
        heatmap.set("radius", value);
    } 

  const getLocationData = async url => {
    const response = await fetch(url)
    return response.json()
  }    
   
  function addInfoWindow(name , description) {  
    let infoWindow =  new google.maps.InfoWindow({
        content: `<h3> ${name} </h3>   <p> ${description} </p>`,
    })
    return infoWindow;
  }
 
  function addMarker(building , map) { 
    let marker = new google.maps.Marker({
        position: new google.maps.LatLng(building.position.lat, building.position.lng),
        map: map,  
        title : building.name,    
    });  
      
    let infoWindow = addInfoWindow(building.name , building.description); 
     
    return {marker : marker , infoWindow : infoWindow , name : name}
}
 
 
    function toggleHeatmap() {
        heatmap.setMap(heatmap.getMap() ? null : map);
    } 

  async function initMap() { 

    var glasgow = {
        lat: 55.872883,  
        lng: -4.291279,
    }; 

    map = new google.maps.Map(
        document.getElementById('map'), {
            zoom: 17,
            center: glasgow
        });
    
     
    let data = await getLocationData('http://localhost:3000/getlocations');   
    data = JSON.parse(data);  
    let markers = []; 

    for (i = 0 ; i < data.length ; i++) {  
        let buildingOld = data[i];  
        buildingOld["Geolocation"] = buildingOld["Geolocation"].replace('{' , '').replace('}' , '').split(" "); 
        let buildingNew = {  
            name : buildingOld["Building Name"],
            position : { 
                lat : parseFloat(buildingOld["Geolocation"][0]), 
                lng : parseFloat(buildingOld["Geolocation"][1]),
            }, 
            openingTimes : buildingOld["Opening Times"],  
            description : buildingOld["Description"],
        }  
        buildings[i] = buildingNew; 
        
        markers.push(addMarker(buildingNew , map));
    }   
     
    for (let i in buildings) { 
        let building = buildings[i]; 
        let option = document.createElement("a"); 
  
        option
        // <a class="dropdown-item" href="#">Action</a>
        document.getElementById("locations").appendChild();
    }
     
    for (i = 0 ; i < markers.length ; i++) {  
        let marker = markers[i];
        marker.marker.addListener("click", () => {  
            console.log("click")
            for (i = 0 ; i < markers.length ; i++) { 
                let subMarker = markers[i].infoWindow; 
                subMarker.close();
            } 

            marker.infoWindow.open({
                anchor: marker.marker,
                map,
                ariaLabel: marker.name,
        });
    }); 
    }    
    }  
       
    var peopleAtLocation = []; 
    async function sendTimes() {   
         
        if (heatmap != null) { 
            heatmap.setMap(null); 
        }
        for (let building in buildings) {   
            building = buildings[building];   
                let response = await sendTime(building.name); 
                peopleAtLocation.push({  
                    building : building,
                    people : JSON.parse(response), 
                    amount : JSON.parse(response).length,
                });
            
        }  
        console.log(peopleAtLocation); 
         
            let heatMapData = [];
        for (k = 0 ; k  < peopleAtLocation.length ; k++) { 
            let currentBuilding = peopleAtLocation[k];   
            console.log(currentBuilding);
            heatMapData.push({ 
                location: new google.maps.LatLng(currentBuilding.building.position.lat , currentBuilding.building.position.lng),  
                weight:currentBuilding.amount, 
                radius : 100,
            });
        }   
         
        console.log(heatMapData);
         
        heatmap = new google.maps.visualization.HeatmapLayer({
           data: heatMapData
        }); 
        heatmap.setMap(map);
         
         
        //let whereToAdd = document.getElementById("row-of-columns")
//         for (k = 0 ; k  < peopleAtLocation ; k++) { 
//             let currentBuilding = peopleAtLocation[k]; 
//             let child = document.createElement(`<div class="col"> 
//                 ${currentBuilding.building}
//             </div>`) 
//             for (u = 0 ; u < currentBuilding.people.length ; u++) {  
//                 let currentPerson = currentBuilding.people[u];  
//                 console.log(currentPerson);
//                 child.appendChild(document.createElement(`<div class="card" style="width: 1rem;">
//   <div class="card-body">
//     <h5 class="card-title">Card title</h5>
//     <p class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</p>
//     <a href="#" class="btn btn-primary">Go somewhere</a>
//   </div>
// </div>`))
//             } 
//             whereToAdd.appendChild(child);
//         }

    }
    async function sendTime(building) { 
       
        let response = await fetch(`http://localhost:3000/gettime?hoursStart=${timeStartG.hours}&minutesStart=${timeStartG.minutes}&hoursEnd=${timeEndG.hours}&minutesEnd=${timeEndG.minutes}&building=${building}`); 
        return response.json();
    } 
      
    function calculateHourBasedOnMinutes(value) {   
        console.log(value);
        let hours = parseInt(value / 60);  
        let minutes = value % 60;
        if (hours != 0 ) { 
            minutes = value - hours*60;
        } else { 
            minutes = value;
        }   
         
        if (hours == 24) { 
            hours = 0;
        } 
         
         
        if (hours < 10 && hours >= 0) { 
            hours = '0' + hours.toString();
        } else { 
            hours = hours.toString();
        } 
        if (minutes < 10 && minutes >= 0) { 
            minutes = '0' + minutes.toString();
        } else { 
            minutes = minutes.toString();
        }
          
        return {hours : hours , minutes : minutes}
    }
 
async function controlFromInput(fromSlider, fromInput, toInput, controlSlider) {
    const [from, to] = getParsed(fromInput, toInput);
    fillSlider(fromInput, toInput, '#C6C6C6', '#25daa5', controlSlider); 
    let timeStart = calculateHourBasedOnMinutes(to); 
    let timeEnd = calculateHourBasedOnMinutes(from);
    if (from > to) {
        fromSlider.value = to; 
        fromInput.innerText = timeStart.hours + ':' + timeStart.minutes;  
    } else { 
        fromSlider.value = from; 
    }  
    timeStartG = timeStart; 
    timeEndG = timeEnd;
}
    
async function controlToInput(toSlider, fromInput, toInput, controlSlider) {
    const [from, to] = getParsed(fromInput, toInput);
    fillSlider(fromInput, toInput, '#C6C6C6', '#25daa5', controlSlider);
    setToggleAccessible(toInput); 
    let timeStart = calculateHourBasedOnMinutes(to); 
    let timeEnd = calculateHourBasedOnMinutes(from);
    if (from <= to) {
        toSlider.value = to; 
        toInput.innerText = timeStart.hours + ':' + timeStart.minutes; 
    } else { 
        toInput.innerText = timeEnd.hours + ':' + timeEnd.minutes; 
        
    }  
    timeStartG = timeStart; 
    timeEndG = timeEnd;
}

async function controlFromSlider(fromSlider, toSlider, fromInput) {
  const [from, to] = getParsed(fromSlider, toSlider);
  fillSlider(fromSlider, toSlider, '#C6C6C6', '#25daa5', toSlider); 
  let timeStart = calculateHourBasedOnMinutes(to); 
    let timeEnd = calculateHourBasedOnMinutes(from);
  if (from > to) {
    toSlider.value = to; 
    fromInput.innerText =  timeStart.hours + ':' + timeStart.minutes; 
  } else { 
    let time = calculateHourBasedOnMinutes(from); 
    fromInput.innerText = timeEnd.hours + ':' + timeEnd.minutes; 
  }  
  timeStartG = timeStart; 
  timeEndG = timeEnd;
}

async function controlToSlider(fromSlider, toSlider, toInput) {
  const [from, to] = getParsed(fromSlider, toSlider);
  fillSlider(fromSlider, toSlider, '#C6C6C6', '#25daa5', toSlider); 
  let timeStart = calculateHourBasedOnMinutes(to); 
  let timeEnd = calculateHourBasedOnMinutes(from);
  setToggleAccessible(toSlider);
  if (from <= to) {
    toSlider.value = to;
    toInput.innerText = to;  
    toInput.innerText = timeStart.hours + ':' + timeStart.minutes; 
  } else {  
    toInput.innerText = timeEnd.hours + ':' + timeEnd.minutes; 
    toSlider.value = from;
  }  
   
  timeStartG = timeStart; 
  timeEndG = timeEnd;
}

function getParsed(currentFrom, currentTo) {
  const from = parseInt(currentFrom.value, 10);
  const to = parseInt(currentTo.value, 10);
  return [from, to];
}

function fillSlider(from, to, sliderColor, rangeColor, controlSlider) {
    const rangeDistance = to.max-to.min;
    const fromPosition = from.value - to.min;
    const toPosition = to.value - to.min;
    controlSlider.style.background = `linear-gradient(
      to right,
      ${sliderColor} 0%,
      ${sliderColor} ${(fromPosition)/(rangeDistance)*100}%,
      ${rangeColor} ${((fromPosition)/(rangeDistance))*100}%,
      ${rangeColor} ${(toPosition)/(rangeDistance)*100}%, 
      ${sliderColor} ${(toPosition)/(rangeDistance)*100}%, 
      ${sliderColor} 100%)`;
}

function setToggleAccessible(currentTarget) {
  const toSlider = document.querySelector('#toSlider');
  if (Number(currentTarget.value) <= 0 ) {
    toSlider.style.zIndex = 2;
  } else {
    toSlider.style.zIndex = 0;
  }
}

const fromSlider = document.querySelector('#fromSlider');
const toSlider = document.querySelector('#toSlider');
const fromInput = document.querySelector('#fromInput');
const toInput = document.querySelector('#toInput');
fillSlider(fromSlider, toSlider, '#C6C6C6', '#25daa5', toSlider);
setToggleAccessible(toSlider);

fromSlider.oninput = () => controlFromSlider(fromSlider, toSlider, fromInput);
toSlider.oninput = () => controlToSlider(fromSlider, toSlider, toInput);
fromInput.oninput = () => controlFromInput(fromSlider, fromInput, toInput, toSlider);
toInput.oninput = () => controlToInput(toSlider, fromInput, toInput, toSlider);
</script>
